import numpy as np

import matplotlib.pyplot as plt

from scipy.signal import butter, filtfilt, lfilter, find_peaks

import serial

import time

# --------------------------- Serial Data Acquisition --------------------------- #

# Serial Connection to Arduino

SERIAL_PORT = "COM4" # Change this

BAUD_RATE = 9600

DURATION = 300 # seconds

fs = 250 # Hz

try:

ser = serial.Serial(SERIAL_PORT, BAUD_RATE, timeout=1)

print(" Connected to Arduino!")

except Exception as e:

print(f" Error connecting to Arduino: {e}")

exit()

# Data Collection

total_samples = fs * DURATION

ecg_data = []

print(" Collecting ECG data...")

start_time = time.time()

while len(ecg_data) < total_samples:

try:

line = ser.readline().decode('utf-8').strip()

if line.isdigit():

ecg_data.append(int(line))

except Exception as e:

print(f" Serial Read Error: {e}")

if time.time() - start_time > DURATION:

print("Timeout reached.")

break

ser.close()

print(" Data collection complete!")

ecg_data = np.array(ecg_data)

# --------------------------- Preprocessing --------------------------- #

# Bandpass Filter Function

def butter_bandpass(lowcut, highcut, fs, order=4):

nyquist = 0.5 * fs

low = lowcut / nyquist

high = highcut / nyquist

b, a = butter(order, [low, high], btype='band')

return b, a

def apply_bandpass_filter(data, lowcut=0.5, highcut=35.0, fs=250, order=4):

if len(data) == 0:

raise ValueError("ECG data is empty! Check serial communication.")

b, a = butter_bandpass(lowcut, highcut, fs, order=order)

if len(data) < max(len(a), len(b)) * 3:

print(" Data too short for filtfilt, using lfilter instead.")

return lfilter(b, a, data) # Use lfilter for short signals

return filtfilt(b, a, data)
